<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>用Go实现Actor模型 | Lionel's Blog</title><link href=/favicon.ico rel="shortcut icon" type=image/x-icon><meta name=author content="归零"><meta name=description content="随着多核CPU的出现，我们需要能够利用这些额外内核的编程模式，以并发的方式处理任务。 Actor模型就是这样一种模式，它模拟了大量独立的工作，以任何顺序处理，不需要锁同步。 Actor模型的一个非常普遍的用法可以在网络服务器中找到，Java中的Play! Java中的框架就是一个例子。一般来说，任何并发的应用程序都可以建立在Actor模型之上。
在这篇文章中，我将实践如何用Go实现一个原始的actor模型。我们将利用Go为并发提供的工具&amp;ndash;goroutines、channels和wait groups。
"><meta name=generator content="Hugo 0.81.0"><link rel=canonical href=https://lixianwa.github.io/posts/%E7%94%A8go%E5%AE%9E%E7%8E%B0actor%E6%A8%A1%E5%9E%8B/><meta property="og:title" content="用Go实现Actor模型"><meta property="og:description" content="随着多核CPU的出现，我们需要能够利用这些额外内核的编程模式，以并发的方式处理任务。
Actor模型就是这样一种模式，它模拟了大量独立的工作，以任何顺序处理，不需要锁同步。
Actor模型的一个非常普遍的用法可以在网络服务器中找到，Java中的Play! Java中的框架就是一个例子。一般来说，任何并发的应用程序都可以建立在Actor模型之上。
在这篇文章中，我将实践如何用Go实现一个原始的actor模型。我们将利用Go为并发提供的工具&ndash;goroutines、channels和wait groups。"><meta property="og:type" content="article"><meta property="og:url" content="https://lixianwa.github.io/posts/%E7%94%A8go%E5%AE%9E%E7%8E%B0actor%E6%A8%A1%E5%9E%8B/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-22T17:03:42+08:00"><meta property="article:modified_time" content="2022-03-22T17:03:42+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="用Go实现Actor模型"><meta name=twitter:description content="随着多核CPU的出现，我们需要能够利用这些额外内核的编程模式，以并发的方式处理任务。
Actor模型就是这样一种模式，它模拟了大量独立的工作，以任何顺序处理，不需要锁同步。
Actor模型的一个非常普遍的用法可以在网络服务器中找到，Java中的Play! Java中的框架就是一个例子。一般来说，任何并发的应用程序都可以建立在Actor模型之上。
在这篇文章中，我将实践如何用Go实现一个原始的actor模型。我们将利用Go为并发提供的工具&ndash;goroutines、channels和wait groups。"><link rel=stylesheet href=/css/semantic.min.css><link rel=stylesheet href=/css/icomoon.css><link rel=stylesheet href=/css/OverlayScrollbars.min.css><link rel=stylesheet href=/css/github-markdown.css><link rel=stylesheet href=/css/site.css><style>a:not(.ui.button):hover{text-decoration:underline}a:not(.ui.button){color:#2e8b57!important}.inverted a:not(.ui.button),.inverted a:not(.ui.button):hover{color:#8fbc8f!important}body.default{background-color:#f7f7f7;background-image:url(/me/background.jpeg)}body.dark{background-color:#000}</style><link rel=stylesheet data-highlight href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/styles/gruvbox-light.min.css><link rel=stylesheet href=/css/custom.css></head><body class=default><nav class="ui secondary menu dream-menu"><div class=item><i class="large link bullseye icon dream-flip-toggle" title=翻转！></i></div><div class=item><i class="large link home icon" title=首页 onclick="window.location.href='https://lixianwa.github.io/'"></i></div><div class=item><i class="large link icon theme-switch" onclick=themeSwitch()></i></div><div class=item><i class="large link search icon" onclick=toggleSearch()></i></div></nav><div class=flip-container><div class=flipper><section class=front><div class=dream-max-width><div class="ui relaxed grid dream-grid dream-grid-single"><aside class="sixteen wide mobile sixteen wide tablet four wide computer column dream-single-aside"><div class="ui segment toc"><nav id=TableOfContents><ul><li><a href=#actorsystem>ActorSystem</a></li><li><a href=#task-assigner>Task Assigner</a></li><li><a href=#task-actor>Task Actor</a></li><li><a href=#benchmarks>Benchmarks</a></li></ul></nav></div><div class="ui segment actions"><button class="ui circular icon button save-as-image" title=保存为图片 onclick=savePostAsImg()>
<i class="save icon"></i></button>
<a href="https://twitter.com/intent/tweet?text=%e7%94%a8Go%e5%ae%9e%e7%8e%b0Actor%e6%a8%a1%e5%9e%8b&url=https%3a%2f%2flixianwa.github.io%2fposts%2f%25E7%2594%25A8go%25E5%25AE%259E%25E7%258E%25B0actor%25E6%25A8%25A1%25E5%259E%258B%2f" class="ui circular twitter icon button"><i class="twitter icon"></i></a><a href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2flixianwa.github.io%2fposts%2f%25E7%2594%25A8go%25E5%25AE%259E%25E7%258E%25B0actor%25E6%25A8%25A1%25E5%259E%258B%2f" class="ui circular facebook icon button"><i class="facebook icon"></i></a></div></aside><div class="sixteen wide mobile sixteen wide tablet twelve wide computer column markdown-body dream-single" id=dream-save-post-as-img><section class="ui attached segment"><header><h1 class="ui large header">用Go实现Actor模型<div class="sub header">@
归零
|
星期二，三月 22 日，2022 年
| 3 分钟阅读
| 更新于
星期二，三月 22 日，2022 年</div></h1></header><article class=main><p>随着多核CPU的出现，我们需要能够利用这些额外内核的编程模式，以并发的方式处理任务。
Actor模型就是这样一种模式，它模拟了大量独立的工作，以任何顺序处理，不需要锁同步。
Actor模型的一个非常普遍的用法可以在网络服务器中找到，Java中的Play! Java中的框架就是一个例子。一般来说，任何并发的应用程序都可以建立在Actor模型之上。</p><p>在这篇文章中，我将实践如何用Go实现一个原始的actor模型。我们将利用Go为并发提供的工具&ndash;goroutines、channels和wait groups。</p><p>首先，让我们来看看一个Actor。</p><p><img src=/images/implement-actor-with-go1.png alt=Actor></p><p>一个 Actor 有一个任务队列和一个监听任务队列并执行任务的 goroutine。 这里的A是一个goroutine，它在任务队列上阻塞，并不断执行队列中的任务。
Actor 的interface 定义如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Actor</span> <span style=color:#66d9ef>interface</span> {
   <span style=color:#a6e22e>AddTask</span>(<span style=color:#a6e22e>task</span> <span style=color:#a6e22e>Task</span>)
   <span style=color:#a6e22e>Start</span>()
   <span style=color:#a6e22e>Stop</span>()
}
</code></pre></div><p>接下来看看 任务（task）</p><p>task是在Actor中执行的。它是对有Execute方法的interface的实现。任何可以通过调用Execute的任何东西。task是我们需要做的工作的业务实现。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Task</span> <span style=color:#66d9ef>interface</span> {
   <span style=color:#a6e22e>Execute</span>()
}
</code></pre></div><p>完整的系统架构图如下：
<img src=/images/implement-actor-with-go2.png alt=image></p><p>actor system接口定义如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ActorSystem</span> <span style=color:#66d9ef>interface</span> {
   <span style=color:#a6e22e>Run</span>()
   <span style=color:#a6e22e>SubmitTask</span>(<span style=color:#a6e22e>task</span> <span style=color:#a6e22e>Task</span>) 
   <span style=color:#a6e22e>Shutdown</span>(<span style=color:#a6e22e>shutdownWG</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>)
}
</code></pre></div><p>调用<code>SubmitTask</code>方法提交<code>Task</code>s 到<code>ActorSystem</code>中。<code>taskAssigner</code> 分配task到<code>Actor</code>s。 每个<code>Actor</code>都有一个任务队列, 用于缓冲任务并逐一执行。</p><p>接下来我们深入研究一下每一个模块</p><h2 id=actorsystem>ActorSystem</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ActorSystem</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>name</span>           <span style=color:#66d9ef>string</span>
	<span style=color:#a6e22e>assigner</span> 	   <span style=color:#a6e22e>entities</span>.<span style=color:#a6e22e>Actor</span>
	<span style=color:#a6e22e>wg</span>             <span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>
	<span style=color:#a6e22e>tracker</span>        <span style=color:#f92672>*</span><span style=color:#a6e22e>tracker</span>.<span style=color:#a6e22e>Tracker</span>
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>system</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ActorSystem</span>) <span style=color:#a6e22e>Run</span>() {
	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;actor system %s started \n&#34;</span>, <span style=color:#a6e22e>system</span>.<span style=color:#a6e22e>name</span>)
  <span style=color:#75715e>// start the assigner in seprate go routine
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>system</span>.<span style=color:#a6e22e>assigner</span>.<span style=color:#a6e22e>Start</span>()
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>system</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ActorSystem</span>) <span style=color:#a6e22e>SubmitTask</span>(<span style=color:#a6e22e>task</span> <span style=color:#a6e22e>entities</span>.<span style=color:#a6e22e>Task</span>) <span style=color:#66d9ef>error</span> {
  <span style=color:#75715e>// adding submitted task to assigner
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>system</span>.<span style=color:#a6e22e>assigner</span>.<span style=color:#a6e22e>AddTask</span>(<span style=color:#a6e22e>task</span>)
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>system</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ActorSystem</span>) <span style=color:#a6e22e>Shutdown</span>(<span style=color:#a6e22e>wg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>) {
	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()
	<span style=color:#a6e22e>system</span>.<span style=color:#a6e22e>assigner</span>.<span style=color:#a6e22e>Stop</span>()
	<span style=color:#a6e22e>system</span>.<span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Wait</span>()
	<span style=color:#a6e22e>system</span>.<span style=color:#a6e22e>tracker</span>.<span style=color:#a6e22e>Shutdown</span>()
	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;actor system: %s shutdown completed &#34;</span>, <span style=color:#a6e22e>system</span>.<span style=color:#a6e22e>name</span>)
}
</code></pre></div><p>当ActorSystem启动时，它启动了一个<code>taskAssigner</code> actor, 每一个进入系统的<code>Task</code>都会通过调用AddTask方法添加到<code>taskAssigner</code>的actor中。</p><p>通过调用<code>SubbmitTask</code>方法，我们可以提交一个<code>Task</code>到<code>ActorSystem</code>中。</p><p>在Shutdown时，它将关闭阻止任何新的传入任务的任务通道，等待将所有接收的任务分配给Actors。然后它调用每一个<code>Actor</code>的<code>Stop</code>，等待它们完成。</p><h2 id=task-assigner>Task Assigner</h2><p>我们将每个传入的<code>Tasks</code>放在任务通道，<code>taskAssigner</code>和<code>Task</code>在每一个Actor的队列内部。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>AssignerActor</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>name</span>     <span style=color:#66d9ef>string</span>
	<span style=color:#a6e22e>closeSig</span> <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>bool</span>
	<span style=color:#a6e22e>tasks</span>    <span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>entities</span>.<span style=color:#a6e22e>Task</span>
	<span style=color:#a6e22e>assignerIndex</span> <span style=color:#66d9ef>int</span>
	<span style=color:#a6e22e>tracker</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>tracker</span>.<span style=color:#a6e22e>Tracker</span>
	<span style=color:#a6e22e>scalar</span>  <span style=color:#f92672>*</span><span style=color:#a6e22e>autoScalar</span>
	<span style=color:#f92672>*</span><span style=color:#a6e22e>TaskActorPool</span>
	<span style=color:#f92672>*</span><span style=color:#a6e22e>Config</span>
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>assigner</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AssignerActor</span>) <span style=color:#a6e22e>AddTask</span>(<span style=color:#a6e22e>task</span> <span style=color:#a6e22e>entities</span>.<span style=color:#a6e22e>Task</span>) <span style=color:#66d9ef>error</span>{
	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>assigner</span>.<span style=color:#a6e22e>tasks</span>) <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>assignerQueueSize</span> {
		<span style=color:#a6e22e>assigner</span>.<span style=color:#a6e22e>tracker</span>.<span style=color:#a6e22e>GetTrackerChan</span>() <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>tracker</span>.<span style=color:#a6e22e>CreateCounterTrack</span>(<span style=color:#a6e22e>tracker</span>.<span style=color:#a6e22e>Task</span>, <span style=color:#a6e22e>tracker</span>.<span style=color:#a6e22e>Rejected</span>)
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;task queue is full&#34;</span>)
	}
	<span style=color:#75715e>// task getting added to assigner actor channel 
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>assigner</span>.<span style=color:#a6e22e>tasks</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>task</span>
	<span style=color:#a6e22e>assigner</span>.<span style=color:#a6e22e>tracker</span>.<span style=color:#a6e22e>GetTrackerChan</span>() <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>tracker</span>.<span style=color:#a6e22e>CreateCounterTrack</span>(<span style=color:#a6e22e>tracker</span>.<span style=color:#a6e22e>Task</span>, <span style=color:#a6e22e>tracker</span>.<span style=color:#a6e22e>Submitted</span>)
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
}
</code></pre></div><p><code>taskAssigner</code>内部处理tasks channel 和分发 task 到某个actor任务池中通过调用AddTask方法。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>assigner</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AssignerActor</span>) <span style=color:#a6e22e>Start</span>() {
	<span style=color:#a6e22e>poolStarted</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>bool</span>)
	<span style=color:#a6e22e>assigner</span>.<span style=color:#a6e22e>scalar</span> = <span style=color:#a6e22e>GetAutoScaler</span>(<span style=color:#a6e22e>assigner</span>, <span style=color:#a6e22e>poolStarted</span>)
	<span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>poolStarted</span>
        <span style=color:#75715e>// will loop forever till tasks channel is closed
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>task</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>assigner</span>.<span style=color:#a6e22e>tasks</span> {
		<span style=color:#66d9ef>for</span> {
			<span style=color:#a6e22e>assigner</span>.<span style=color:#a6e22e>poolLock</span>.<span style=color:#a6e22e>Lock</span>()
			<span style=color:#a6e22e>assigner</span>.<span style=color:#a6e22e>assignerIndex</span> = <span style=color:#a6e22e>assigner</span>.<span style=color:#a6e22e>assignerIndex</span> <span style=color:#f92672>%</span> len(<span style=color:#a6e22e>assigner</span>.<span style=color:#a6e22e>pool</span>)
			<span style=color:#a6e22e>actor</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>assigner</span>.<span style=color:#a6e22e>pool</span>[<span style=color:#a6e22e>assigner</span>.<span style=color:#a6e22e>assignerIndex</span>]
			<span style=color:#a6e22e>assigner</span>.<span style=color:#a6e22e>assignerIndex</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
			<span style=color:#a6e22e>assigner</span>.<span style=color:#a6e22e>poolLock</span>.<span style=color:#a6e22e>Unlock</span>()
			<span style=color:#75715e>// assigning task to a task actor from pool
</span><span style=color:#75715e></span>			<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>actor</span>.<span style=color:#a6e22e>AddTask</span>(<span style=color:#a6e22e>task</span>)
			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
				<span style=color:#66d9ef>break</span>
			}
		}
	}
	<span style=color:#a6e22e>assigner</span>.<span style=color:#a6e22e>closeSig</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>true</span>
}
</code></pre></div><p><code>autoScalar</code> 保持监听<code>tasks</code>的数目， 增加或减少 <code>task actor pool</code>的大小。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=color:#75715e>// auto scalar is part of task assigner actor
</span><span style=color:#75715e>// It scales task actor pool based on queue len size
</span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>autoScalar</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#f92672>*</span><span style=color:#a6e22e>AssignerActor</span>
	<span style=color:#a6e22e>lastActorId</span> <span style=color:#66d9ef>int</span>
	<span style=color:#a6e22e>closingSig</span>  <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>bool</span>
	<span style=color:#a6e22e>closedSig</span>   <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>bool</span>
}

<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>scalar</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>autoScalar</span>) <span style=color:#a6e22e>run</span>(<span style=color:#a6e22e>poolStarted</span> <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>bool</span>) {
	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;running auto scalar with min actor&#34;</span>)
  <span style=color:#75715e>// provision starting actors
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>scalar</span>.<span style=color:#a6e22e>provisionActors</span>(<span style=color:#a6e22e>scalar</span>.<span style=color:#a6e22e>Config</span>.<span style=color:#a6e22e>MinActor</span>)
	<span style=color:#75715e>// waiting for scalar to start task actors
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>poolStarted</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>true</span>
	<span style=color:#a6e22e>completed</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>false</span>

<span style=color:#66d9ef>for</span> !<span style=color:#a6e22e>completed</span> {
		<span style=color:#66d9ef>select</span> {
		<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>scalar</span>.<span style=color:#a6e22e>closingSig</span>:
			<span style=color:#a6e22e>completed</span> = <span style=color:#66d9ef>true</span>
		<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>After</span>(<span style=color:#ae81ff>100</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>):
			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>scalar</span>.<span style=color:#a6e22e>QueueSize</span>() &gt; <span style=color:#a6e22e>scalar</span>.<span style=color:#a6e22e>UpscaleQueueSize</span> <span style=color:#f92672>&amp;&amp;</span> len(<span style=color:#a6e22e>scalar</span>.<span style=color:#a6e22e>pool</span>) &lt; <span style=color:#a6e22e>scalar</span>.<span style=color:#a6e22e>MaxActor</span> {
				<span style=color:#a6e22e>scalar</span>.<span style=color:#a6e22e>provisionActors</span>(<span style=color:#ae81ff>1</span>)

			} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>scalar</span>.<span style=color:#a6e22e>QueueSize</span>() &lt; <span style=color:#a6e22e>scalar</span>.<span style=color:#a6e22e>DownscaleQueueSize</span> <span style=color:#f92672>&amp;&amp;</span> len(<span style=color:#a6e22e>scalar</span>.<span style=color:#a6e22e>pool</span>) &gt; <span style=color:#a6e22e>scalar</span>.<span style=color:#a6e22e>MinActor</span> {
				<span style=color:#a6e22e>scalar</span>.<span style=color:#a6e22e>deprovisionActors</span>(<span style=color:#ae81ff>1</span>)
			}
		}
	}
  <span style=color:#75715e>// when it comes out, it closes all task actors in pool
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>scalar</span>.<span style=color:#a6e22e>deprovisionActors</span>(len(<span style=color:#a6e22e>scalar</span>.<span style=color:#a6e22e>pool</span>))
	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;scalar exited&#34;</span>)
	<span style=color:#a6e22e>scalar</span>.<span style=color:#a6e22e>closedSig</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>true</span>
}
</code></pre></div><h2 id=task-actor>Task Actor</h2><p>它也是一个actor，它的职责是执行添加到它的channel中的任务</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>TaskActor</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>id</span> <span style=color:#66d9ef>int</span>
	<span style=color:#a6e22e>closeSig</span> <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>bool</span>
	<span style=color:#a6e22e>wg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>
	<span style=color:#a6e22e>tasks</span> <span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>entities</span>.<span style=color:#a6e22e>Task</span>
	<span style=color:#a6e22e>tracker</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>tracker</span>.<span style=color:#a6e22e>Tracker</span>
}

<span style=color:#75715e>// add task only if channel has space
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>a</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>TaskActor</span>) <span style=color:#a6e22e>AddTask</span>(<span style=color:#a6e22e>task</span> <span style=color:#a6e22e>entities</span>.<span style=color:#a6e22e>Task</span>) <span style=color:#66d9ef>error</span> {
	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>tasks</span>) <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>taskQueueSize</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;filled queue&#34;</span>)
	}
  <span style=color:#75715e>// task added to channel
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>tasks</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>task</span>
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>a</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>TaskActor</span>) <span style=color:#a6e22e>Start</span>() {
	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()
	<span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>1</span>)
	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;starting actor :%d&#34;</span>, <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>id</span>)

  <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>task</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>tasks</span>{
		<span style=color:#a6e22e>task</span>.<span style=color:#a6e22e>Execute</span>()
		<span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>tracker</span>.<span style=color:#a6e22e>GetTrackerChan</span>() <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>tracker</span>.<span style=color:#a6e22e>CreateCounterTrack</span>(<span style=color:#a6e22e>tracker</span>.<span style=color:#a6e22e>Task</span>, <span style=color:#a6e22e>tracker</span>.<span style=color:#a6e22e>Completed</span>)
	}
	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#e6db74>&#34;stopped actor :%d&#34;</span>, <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>id</span>)
	<span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>closeSig</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>true</span>
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>a</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>TaskActor</span>) <span style=color:#a6e22e>Stop</span>() {
  <span style=color:#75715e>// closing task channel
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>close</span> (<span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>tasks</span>)
	<span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>closeSig</span>
}
</code></pre></div><h2 id=benchmarks>Benchmarks</h2><p>我们模拟了一个Web服务器。</p><ul><li>100K请求以2毫秒的间隔线性发送</li><li>当时钟在前30秒的时间和[50-100）持续30秒钟内时钟，每个请求持续[0,50）〜25米秒〜25米秒。</li><li>这模拟了我们在下游服务中突然变化的情况。我们希望保持我们的吞吐量检查，以便不增加任何任务的等待时间</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestIOSimulationSystem</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
  <span style=color:#75715e>// creating a actor system
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>ioSimSystem</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>CreateActorSystem</span>(<span style=color:#e6db74>&#34;io_sim&#34;</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>actor</span>.<span style=color:#a6e22e>Config</span>{
		<span style=color:#a6e22e>MinActor</span>: <span style=color:#ae81ff>10</span>,
		<span style=color:#a6e22e>MaxActor</span>: <span style=color:#ae81ff>100</span>,
		<span style=color:#a6e22e>AutoScale</span>: <span style=color:#a6e22e>actor</span>.<span style=color:#a6e22e>AutoScale</span>{
			<span style=color:#a6e22e>UpscaleQueueSize</span>:   <span style=color:#ae81ff>100</span>,
			<span style=color:#a6e22e>DownscaleQueueSize</span>: <span style=color:#ae81ff>10</span>,
		},
	})

	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#ae81ff>100000</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span> {
		<span style=color:#a6e22e>ioSimSystem</span>.<span style=color:#a6e22e>SubmitTask</span>(<span style=color:#a6e22e>CreateNumberPrinterTask</span>(<span style=color:#a6e22e>i</span>))
		<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>After</span>(<span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
	}

	<span style=color:#a6e22e>shutdown</span>([]<span style=color:#f92672>*</span><span style=color:#a6e22e>ActorSystem</span>{<span style=color:#a6e22e>ioSimSystem</span>})
}

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>SimIOTask</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>num</span> <span style=color:#66d9ef>int</span>
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>SimIOTask</span>) <span style=color:#a6e22e>Execute</span>() {
	<span style=color:#a6e22e>x</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>Second</span>() &gt; <span style=color:#ae81ff>30</span> {
		<span style=color:#a6e22e>x</span> = <span style=color:#ae81ff>100</span>
	}
	<span style=color:#a6e22e>duration</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#a6e22e>x</span><span style=color:#f92672>+</span><span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Intn</span>(<span style=color:#ae81ff>75</span>)) <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>
	<span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>After</span>(<span style=color:#a6e22e>duration</span>)
}
</code></pre></div><p>参考链接：
1、https://medium.com/better-programming/implementing-the-actor-model-in-golang-3579c2227b5e</p></article></section><article class="ui segment utterances-comments" data-html2canvas-ignore><script src=https://utteranc.es/client.js repo=lixianwa/comments-for-myblog issue-term=og:title theme=github-light crossorigin=anonymous async></script></article></div></div><footer class="ui basic center aligned segment" style=background-color:initial><p>© 2014 - 2022 Lionel's Blog</p><p>Powered by <a href=https://gohugo.io/ target=_blank>Hugo</a> with theme <a href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</p></footer></div></section><section class=back><div class=dream-max-width><header class="ui basic very padded segment dream-header"><div class="ui small circular image"><img src=/me/avatar.jpeg alt=avatar></div><div class=content><h1 class="ui medium header">归零的小窝<div class="sub header">收集、总结、分享</div></h1><article class="ui horizontal list"><a class=item href=/posts><i class="archive icon" title=归档></i></a><a class=item href=/categories><i class="th list icon" title=所有分类></i></a><a class=item href=/tags><i class="tags icon" title=所有标签></i></a></article><article class=dream-tags><a class="ui label" href=/tags/actor/ title=Actor>Actor</a>
<a class="ui label" href=/tags/archlinux/ title=archlinux>archlinux</a>
<a class="ui label" href=/tags/arthas/ title=arthas>arthas</a>
<a class="ui label" href=/tags/bug/ title=bug>bug</a>
<a class="ui label" href=/tags/c%E8%AF%AD%E8%A8%80/ title=c语言>c语言</a>
<a class="ui label" href=/tags/dapr/ title=Dapr>Dapr</a>
<a class="ui label" href=/tags/debug/ title=debug>debug</a>
<a class="ui label" href=/tags/dlv/ title=dlv>dlv</a>
<a class="ui label" href=/tags/docker/ title=Docker>Docker</a>
<a class="ui label" href=/tags/go/ title=Go>Go</a>
<a class="ui label" href=/tags/grpc/ title=gRPC>gRPC</a>
<a class="ui label" href=/tags/headless-service/ title="Headless service">Headless service</a>
<a class="ui label" href=/tags/hexo/ title=Hexo>Hexo</a>
<a class="ui label" href=/tags/ios/ title=iOS>iOS</a>
<a class="ui label" href=/tags/istio/ title=Istio>Istio</a>
<a class="ui label" href=/tags/java/ title=java>java</a>
<a class="ui label" href=/tags/jekyll/ title=jekyll>jekyll</a>
<a class="ui label" href=/tags/jupyter-notebook/ title="Jupyter notebook">Jupyter notebook</a>
<a class="ui label" href=/tags/kubernetes/ title=Kubernetes>Kubernetes</a>
<a class="ui label" href=/tags/letsencrypt/ title=Letsencrypt>Letsencrypt</a>
<a class="ui label" href=/tags/markdown/ title=markdown>markdown</a>
<a class="ui label" href=/tags/mongodb/ title=mongodb>mongodb</a>
<a class="ui label" href=/tags/nginx/ title=nginx>nginx</a>
<a class="ui label" href=/tags/pandas/ title=Pandas>Pandas</a>
<a class="ui label" href=/tags/reactivecocoa/ title=ReactiveCocoa>ReactiveCocoa</a>
<a class="ui label" href=/tags/redis/ title=redis>redis</a>
<a class="ui label" href=/tags/restful-api/ title="RESTFul API">RESTFul API</a>
<a class="ui label" href=/tags/solid/ title=SOLID>SOLID</a>
<a class="ui label" href=/tags/ssl%E8%AF%81%E4%B9%A6/ title=SSL证书>SSL证书</a>
<a class="ui label" href=/tags/swift/ title=Swift>Swift</a>
<a class="ui label" href=/tags/v2ray/ title=v2ray>v2ray</a>
<a class="ui label" href=/tags/xcode/ title=Xcode>Xcode</a>
<a class="ui label" href=/tags/%E5%86%85%E5%AD%98/ title=内存>内存</a>
<a class="ui label" href=/tags/%E5%8D%9A%E5%AE%A2/ title=博客>博客</a>
<a class="ui label" href=/tags/%E5%B7%A5%E5%85%B7/ title=工具>工具</a>
<a class="ui label" href=/tags/%E5%BC%80%E6%BA%90/ title=开源>开源</a>
<a class="ui label" href=/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/ title=微服务>微服务</a>
<a class="ui label" href=/tags/%E6%8F%90%E9%97%AE/ title=提问>提问</a>
<a class="ui label" href=/tags/%E6%95%99%E7%A8%8B/ title=教程>教程</a>
<a class="ui label" href=/tags/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/ title=数据分析>数据分析</a>
<a class="ui label" href=/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/ title=数据库>数据库</a>
<a class="ui label" href=/tags/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/ title=最佳实践>最佳实践</a>
<a class="ui label" href=/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/ title=“机器学习”>“机器学习”</a>
<a class="ui label" href=/tags/%E6%AD%BB%E6%9C%BA/ title=死机>死机</a>
<a class="ui label" href=/tags/%E6%B3%9B%E5%9E%8B/ title=泛型>泛型</a>
<a class="ui label" href=/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/ title=“深度学习”>“深度学习”</a>
<a class="ui label" href=/tags/%E6%B8%B8%E8%AE%B0/ title=游记>游记</a>
<a class="ui label" href=/tags/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/ title=科学上网>科学上网</a>
<a class="ui label" href=/tags/%E7%AE%97%E5%AD%90/ title=算子>算子</a>
<a class="ui label" href=/tags/%E7%BC%96%E8%AF%91%E5%99%A8%E4%BC%98%E5%8C%96/ title=编译器优化>编译器优化</a>
<a class="ui label" href=/tags/%E7%BF%BB%E8%AF%91/ title=翻译>翻译</a>
<a class="ui label" href=/tags/%E8%87%AA%E8%A1%8C%E8%BD%A6/ title=自行车>自行车</a>
<a class="ui label" href=/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/ title=读书笔记>读书笔记</a></article></div></header><div class="ui relaxed grid dream-grid dream-back"><div class="sixteen wide mobile eight wide tablet four wide computer column dream-column"><article class="ui segment markdown-body"><div class="ui medium header">关于</div><p>要么忙着生活，要么赶着去死!</p></article></div><div class="sixteen wide mobile eight wide tablet four wide computer column dream-column"><article class="ui segment"><div class="ui medium header">社交链接</div><nav class="ui secondary menu dream-menu dream-socials"><div class=item><a href=/index.xml><i class="large rss square icon" title=RSS></i></a></div><div class=item><a href=mailto:lixianwa@gmail.com><i class="large mail icon" title=Email></i></a></div></nav></article></div><div class="sixteen wide mobile eight wide tablet four wide computer column dream-column"><article class="ui segment"><a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/><img alt=知识共享许可协议 style=border-width:0 src=https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png></a><br>本作品采用<a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。</article></div></div></div></section></div></div><script>window.defaultDark=null,window.backgroundDark="black",window.backgroundImageDark=null,window.darkNav=null,window.hasTwitterEmbed=null,window.hasTwitterEmbed&&(window.twttr=function(c,d,e){var b,f=c.getElementsByTagName(d)[0],a=window.twttr||{};return c.getElementById(e)?a:(b=c.createElement(d),b.id=e,b.src='https://platform.twitter.com/widgets.js',f.parentNode.insertBefore(b,f),a._e=[],a.ready=function(b){a._e.push(b)},a)}(document,'script','twitter-wjs'))</script><script src=/js/jquery.min.js></script><script src=/js/semantic.min.js></script><script src=/js/jquery.overlayScrollbars.min.js></script><script src=/js/header.js></script><script src=/js/main.js></script><script src=/js/theme.js></script><script src=/js/html2canvas.min.js></script><script src=/js/post.js></script><script src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/highlight.min.js></script><script src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/languages/ocaml.min.js></script><script>hljs.initHighlightingOnLoad(),setHighlightTheme();function setHighlightTheme(){var a=localStore.getItem('hugo-theme-dream-is-dark'),b,c,d;a=a?a:window.defaultDark?'y':a,b="gruvbox-light",c="gruvbox-dark",d=a==='y'?c:b,$('link[data-highlight]').attr('href','https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/styles/'+d+'.min.css'),$('pre').css('background',a==='y'?'#333':'')}</script><div class="ui inverted segment" id=dream-search><div class="ui search"><div class="ui transparent input"><input class=prompt type=text placeholder=搜索></div><div class=results></div></div></div><script>$(document).ready(function(){$.getJSON('https://lixianwa.github.io//index.json',function(a){$('.ui.search').search({source:a,searchFields:['title'],showNoResults:!0})})})</script><script src=/js/search.js></script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','172168556','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>