<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>聊聊Go1.20即将引入的PGO | Lionel's Blog</title><link href=/favicon.ico rel="shortcut icon" type=image/x-icon><meta name=author content="归零"><meta name=description content="PGO 是什么？ PGO(profile-guided optimization) 配置文件引导的优化，也被称为反馈驱动的优化（FDO），是一种强大的优化技术，它使用程序运行时行为的配置文件来指导编译器对该程序未来构建的优化。这种技术也可以应用于其他构建阶段，如源代码生成、链接时间或链接后时间（如LTO、BOLT、Propeller），甚至是运行时间。
"><meta name=generator content="Hugo 0.81.0"><link rel=canonical href=https://lixianwa.github.io/posts/%E8%81%8A%E8%81%8Ago1.20%E5%8D%B3%E5%B0%86%E5%BC%95%E5%85%A5%E7%9A%84pgo/><meta property="og:title" content="聊聊Go1.20即将引入的PGO"><meta property="og:description" content="PGO 是什么？
PGO(profile-guided optimization) 配置文件引导的优化，也被称为反馈驱动的优化（FDO），是一种强大的优化技术，它使用程序运行时行为的配置文件来指导编译器对该程序未来构建的优化。这种技术也可以应用于其他构建阶段，如源代码生成、链接时间或链接后时间（如LTO、BOLT、Propeller），甚至是运行时间。"><meta property="og:type" content="article"><meta property="og:url" content="https://lixianwa.github.io/posts/%E8%81%8A%E8%81%8Ago1.20%E5%8D%B3%E5%B0%86%E5%BC%95%E5%85%A5%E7%9A%84pgo/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-03T11:48:42+08:00"><meta property="article:modified_time" content="2022-10-03T11:48:42+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="聊聊Go1.20即将引入的PGO"><meta name=twitter:description content="PGO 是什么？
PGO(profile-guided optimization) 配置文件引导的优化，也被称为反馈驱动的优化（FDO），是一种强大的优化技术，它使用程序运行时行为的配置文件来指导编译器对该程序未来构建的优化。这种技术也可以应用于其他构建阶段，如源代码生成、链接时间或链接后时间（如LTO、BOLT、Propeller），甚至是运行时间。"><link rel=stylesheet href=/css/semantic.min.css><link rel=stylesheet href=/css/icomoon.css><link rel=stylesheet href=/css/OverlayScrollbars.min.css><link rel=stylesheet href=/css/github-markdown.css><link rel=stylesheet href=/css/site.css><style>a:not(.ui.button):hover{text-decoration:underline}a:not(.ui.button){color:#2e8b57!important}.inverted a:not(.ui.button),.inverted a:not(.ui.button):hover{color:#8fbc8f!important}body.default{background-color:#f7f7f7;background-image:url(/me/background.jpeg)}body.dark{background-color:#000}</style><link rel=stylesheet data-highlight href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/styles/gruvbox-light.min.css><link rel=stylesheet href=/css/custom.css></head><body class=default><nav class="ui secondary menu dream-menu"><div class=item><i class="large link bullseye icon dream-flip-toggle" title=翻转！></i></div><div class=item><i class="large link home icon" title=首页 onclick="window.location.href='https://lixianwa.github.io/'"></i></div><div class=item><i class="large link icon theme-switch" onclick=themeSwitch()></i></div><div class=item><i class="large link search icon" onclick=toggleSearch()></i></div></nav><div class=flip-container><div class=flipper><section class=front><div class=dream-max-width><div class="ui relaxed grid dream-grid dream-grid-single"><aside class="sixteen wide mobile sixteen wide tablet four wide computer column dream-single-aside"><div class="ui segment toc"><nav id=TableOfContents><ul><li><a href=#pgo-是什么>PGO 是什么？</a></li><li><a href=#实现>实现</a><ul><li><a href=#profile文件来源和格式>profile文件来源和格式</a></li><li><a href=#go命令的变化>go命令的变化</a></li><li><a href=#编译器的变化>编译器的变化</a></li><li><a href=#pgo内联优化>PGO内联优化</a></li></ul></li></ul></nav></div><div class="ui segment actions"><button class="ui circular icon button save-as-image" title=保存为图片 onclick=savePostAsImg()>
<i class="save icon"></i></button>
<a href="https://twitter.com/intent/tweet?text=%e8%81%8a%e8%81%8aGo1.20%e5%8d%b3%e5%b0%86%e5%bc%95%e5%85%a5%e7%9a%84PGO&url=https%3a%2f%2flixianwa.github.io%2fposts%2f%25E8%2581%258A%25E8%2581%258Ago1.20%25E5%258D%25B3%25E5%25B0%2586%25E5%25BC%2595%25E5%2585%25A5%25E7%259A%2584pgo%2f" class="ui circular twitter icon button"><i class="twitter icon"></i></a><a href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2flixianwa.github.io%2fposts%2f%25E8%2581%258A%25E8%2581%258Ago1.20%25E5%258D%25B3%25E5%25B0%2586%25E5%25BC%2595%25E5%2585%25A5%25E7%259A%2584pgo%2f" class="ui circular facebook icon button"><i class="facebook icon"></i></a></div></aside><div class="sixteen wide mobile sixteen wide tablet twelve wide computer column markdown-body dream-single" id=dream-save-post-as-img><section class="ui attached segment"><header><h1 class="ui large header">聊聊Go1.20即将引入的PGO<div class="sub header">@
归零
|
星期一，十月 3 日，2022 年
| 1 分钟阅读
| 更新于
星期一，十月 3 日，2022 年</div></h1></header><article class=main><h2 id=pgo-是什么>PGO 是什么？</h2><p>PGO(profile-guided optimization) 配置文件引导的优化，也被称为反馈驱动的优化（FDO），是一种强大的优化技术，它使用程序运行时行为的配置文件来指导编译器对该程序未来构建的优化。这种技术也可以应用于其他构建阶段，如源代码生成、链接时间或链接后时间（如LTO、BOLT、Propeller），甚至是运行时间。</p><p>与传统的、基于启发式的优化相比，PGO有几个优势。许多编译器的优化是有取舍的：例如，内联通过减少调用开销和启用其他优化来提高性能；但内联也会增加二进制大小，从而增加 I-cache 的压力，所以过多的内联会损害整体性能。优化启发式方法旨在平衡这些权衡，但对于任何特定应用程序的峰值性能来说，很少能实现正确的平衡。使用在运行时收集的配置文件数据，编译器拥有不可能静态得出的信息，因为它取决于应用程序的工作负载，或者在合理的编译时间预算内计算的成本太高。有时，用户会求助于源代码级的编译器指令，如 &ldquo;内联 &ldquo;指令来指导优化工作。然而，源代码级的编译器指令也不是在所有情况下都能很好地工作。例如，一个库的作者想把那些对该库的性能很重要的函数标记为内联。但是对于一个程序来说，这个库的性能可能并不重要。如果我们把所有库中的重要函数都内联，就会导致构建速度慢、二进制大小膨胀，也许运行时性能也会变慢。另一方面，PGO可以利用整个程序的行为信息，只对程序中对性能至关重要的部分进行优化。</p><h2 id=实现>实现</h2><h3 id=profile文件来源和格式>profile文件来源和格式</h3><p>最初将支持pprof CPU配置文件。开发者可以通过通常的方式来收集配置文件，例如 runtime/pprof 或 net/http/pprof 包。编译器将直接读取pprof CPU配置文件。在未来，我们可能会支持更多类型的配置文件</p><h3 id=go命令的变化>go命令的变化</h3><ul><li><p>go命令将在主包的源代码目录中搜索名为default.pgo的配置文件，如果存在的话，将为主包的横向依赖中的所有包提供该配置文件。如果go命令在任何非主包目录下发现default.pgo，它将报告一个错误。在未来，可能会支持为不同的构建配置（如GOOS/GOARCH）自动查找不同的配置文件，但目前我们希望配置文件在不同的配置之间是相当可移植的。</p></li><li><p>为go build添加一个-pgo=命令行标志，指定一个明确的profile文件位置，用于PGO的构建。该标志在以下情况下很有用</p><ul><li>一个具有相同源代码的程序有多个用例，有不同的配置文件</li><li>构建配置对profile文件有很大影响</li><li>用不同的profile文件进行测试</li><li>即使有一个配置文件，也要禁用PGO
具体来说，-pgo=将选择路径上的prefile文件，-pgo=auto将选择主包源码目录下的profile文件；-pgo=off将完全关闭PGO，即使主包源码目录下有一个配置文件存在。</li></ul></li></ul><p>在Go 1.20中默认为关闭，PGO不会被启用。在未来的版本中，默认为自动。</p><p>为了确保构建是可重现的，profile文件的内容将被视为构建的输入，并将被纳入构建缓存密钥计算和BuildInfo。
主软件包的 go test 将使用与 go build 相同的profile文件搜索规则。</p><h3 id=编译器的变化>编译器的变化</h3><p>将修改编译器以支持读取从go命令中传递过来的pprof配置文件，并修改其优化启发式方法以使用这些配置文件信息。这不需要一个新的API。实施细节不包括在本提案中。最初，go team计划增加基于PGO的内联优化。未来将增加更多的优化，如：devirtualization、特定通用函数的模板化、基本块排序和函数布局等。</p><h3 id=pgo内联优化>PGO内联优化</h3><blockquote><p>在计算机科学中，内联函数（有时称作在线函数或编译时期展开函数）是一种编程语言结构，用来建议编译器对一些特殊函数进行内联扩展（有时称作在线扩展）；也就是说建议编译器将指定的函数体插入并取代每一处调用该函数的地方（上下文），从而节省了每次调用函数带来的额外时间开支。但在选择使用内联函数时，必须在程序占用空间和程序执行效率之间进行权衡，因为过多的比较复杂的函数进行内联扩展将带来很大的存储资源开支。另外还需要特别注意的是对递归函数的内联扩展可能引起部分编译器的无穷编译。</p><blockquote><p>注意： 内联优化一般用于能够快速执行的函数，因为在这种情况下函数调用的时间消耗显得更为突出，同时内联体量小的函数也不会明显增加编译后的执行文件占用的空间。</p></blockquote></blockquote><p>PGO 的内联决策基于调用图路径分析。简而言之，使用调用图路径分析进行内联决策背后的基本原则是了解从特定调用路径调用的函数的行为。这很重要，因为来自一个调用路径的函数调用行为可能与另一个调用路径截然不同。了解哪个调用路径更热有助于更好地内联决策，因为优化器仅内联频繁调用路径，从而最大限度地减少内联导致的代码膨胀，但仍通过内联更热的调用路径获得性能。看看下面给出的例子：</p><p><img src="https://raw.githubusercontent.com/lixianwa/resource/master/2022/10/03/1664765344856-9d519df9-1192-4c8d-9551-f7757c1e33b6.png?token=ABJZKOSV2LVLT5K75NSOBN3DHJG52" alt=从“goo”、“foo”和“bat”调用函数“bar”的顺序></p><p>上面中描述的示例说明了从函数“goo”、“foo”和“bat”对函数“bar”进行的函数调用。边缘的数字表示分别从函数“goo”、“foo”和“bat”调用函数“bar”的次数。因此，从函数“goo”到函数“bar”的边表示对于给定的 PGO 培训课程，函数“bar”被函数“goo”调用了 10 次。现在调用图路径分析就是从特定调用路径中找出函数调用的行为。因此，图 1a 将进一步分解为图 1b。</p><p><img src="https://raw.githubusercontent.com/lixianwa/resource/master/2022/10/03/1664765455419-a20d5345-437f-4f00-a7e7-476f4ccf7583.png?token=ABJZKOT5TGEP76XT3GGRZG3DHJHEY" alt="从“goo”、“foo”和“bat”调用函数“bar”的序列 从“bar”调用函数“baz”的序列"></p><p>分析上图， 很明显，考虑到从 &lsquo;bat&rsquo; 到 &lsquo;bar&rsquo; 的调用频率更高，即 100 次调用，主要好处将来自内联函数 &lsquo;bar&rsquo; 到 &lsquo;bat&rsquo;。此外，考虑到从调用路径“goo-bar”和“foo-bar”对函数“baz”的高频率调用，另一个主要优势将来自内联“baz”到“bar”中也很明显。pgo-inlining 对上述场景的影响如下图所示。</p><p><img src="https://raw.githubusercontent.com/lixianwa/resource/master/2022/10/03/1664765438559-c180fecc-18e9-46ca-a5a2-3bd033d3c9a8.png?token=ABJZKOXNDNLIGBTSZ5PAXCLDHJHDW" alt="PGO 内联的影响，“bar”被内联到“bat”，“baz”被内联到“bar”"></p><p>内联决策是在布局、速度与大小决策以及所有其他优化之前做出的。</p><p>未来，Go会添加更多基于PGO的优化，例如Devirtualization，特定通用功能的刻板，基本块排序和功能布局。同时还考虑使用PGO来改善内存行为，例如改进逃生分析和内存分配。以往真实场景使用 PGO 的经验表明，使用PGO优化，程序的性能可以提高 5-15%，而且不用修改一行代码，因此我们对使用 PGO 的 Go 的未来感到兴奋，让我们拭目以待吧。</p><p>参考链接：</p><ol><li><p><a href=https://go.googlesource.com/proposal/+/master/design/55022-pgo.md>https://go.googlesource.com/proposal/+/master/design/55022-pgo.md</a></p></li><li><p><a href=https://github.com/golang/go/issues/55022>https://github.com/golang/go/issues/55022</a></p></li></ol></article></section><article class="ui segment utterances-comments" data-html2canvas-ignore><script src=https://utteranc.es/client.js repo=lixianwa/comments-for-myblog issue-term=og:title theme=github-light crossorigin=anonymous async></script></article></div></div><footer class="ui basic center aligned segment" style=background-color:initial><p>© 2014 - 2022 Lionel's Blog</p><p>Powered by <a href=https://gohugo.io/ target=_blank>Hugo</a> with theme <a href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</p></footer></div></section><section class=back><div class=dream-max-width><header class="ui basic very padded segment dream-header"><div class="ui small circular image"><img src=/me/avatar.jpeg alt=avatar></div><div class=content><h1 class="ui medium header">归零的小窝<div class="sub header">收集、总结、分享</div></h1><article class="ui horizontal list"><a class=item href=/posts><i class="archive icon" title=归档></i></a><a class=item href=/categories><i class="th list icon" title=所有分类></i></a><a class=item href=/tags><i class="tags icon" title=所有标签></i></a></article><article class=dream-tags><a class="ui label" href=/tags/actor/ title=Actor>Actor</a>
<a class="ui label" href=/tags/archlinux/ title=archlinux>archlinux</a>
<a class="ui label" href=/tags/arthas/ title=arthas>arthas</a>
<a class="ui label" href=/tags/bug/ title=bug>bug</a>
<a class="ui label" href=/tags/c%E8%AF%AD%E8%A8%80/ title=c语言>c语言</a>
<a class="ui label" href=/tags/dapr/ title=Dapr>Dapr</a>
<a class="ui label" href=/tags/debug/ title=debug>debug</a>
<a class="ui label" href=/tags/dlv/ title=dlv>dlv</a>
<a class="ui label" href=/tags/docker/ title=Docker>Docker</a>
<a class="ui label" href=/tags/go/ title=Go>Go</a>
<a class="ui label" href=/tags/grpc/ title=gRPC>gRPC</a>
<a class="ui label" href=/tags/headless-service/ title="Headless service">Headless service</a>
<a class="ui label" href=/tags/hexo/ title=Hexo>Hexo</a>
<a class="ui label" href=/tags/ios/ title=iOS>iOS</a>
<a class="ui label" href=/tags/istio/ title=Istio>Istio</a>
<a class="ui label" href=/tags/java/ title=java>java</a>
<a class="ui label" href=/tags/jekyll/ title=jekyll>jekyll</a>
<a class="ui label" href=/tags/jupyter-notebook/ title="Jupyter notebook">Jupyter notebook</a>
<a class="ui label" href=/tags/kubernetes/ title=Kubernetes>Kubernetes</a>
<a class="ui label" href=/tags/letsencrypt/ title=Letsencrypt>Letsencrypt</a>
<a class="ui label" href=/tags/markdown/ title=markdown>markdown</a>
<a class="ui label" href=/tags/mongodb/ title=mongodb>mongodb</a>
<a class="ui label" href=/tags/nginx/ title=nginx>nginx</a>
<a class="ui label" href=/tags/pandas/ title=Pandas>Pandas</a>
<a class="ui label" href=/tags/reactivecocoa/ title=ReactiveCocoa>ReactiveCocoa</a>
<a class="ui label" href=/tags/redis/ title=redis>redis</a>
<a class="ui label" href=/tags/restful-api/ title="RESTFul API">RESTFul API</a>
<a class="ui label" href=/tags/solid/ title=SOLID>SOLID</a>
<a class="ui label" href=/tags/ssl%E8%AF%81%E4%B9%A6/ title=SSL证书>SSL证书</a>
<a class="ui label" href=/tags/swift/ title=Swift>Swift</a>
<a class="ui label" href=/tags/v2ray/ title=v2ray>v2ray</a>
<a class="ui label" href=/tags/xcode/ title=Xcode>Xcode</a>
<a class="ui label" href=/tags/%E5%86%85%E5%AD%98/ title=内存>内存</a>
<a class="ui label" href=/tags/%E5%8D%9A%E5%AE%A2/ title=博客>博客</a>
<a class="ui label" href=/tags/%E5%B7%A5%E5%85%B7/ title=工具>工具</a>
<a class="ui label" href=/tags/%E5%BC%80%E6%BA%90/ title=开源>开源</a>
<a class="ui label" href=/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/ title=微服务>微服务</a>
<a class="ui label" href=/tags/%E6%8F%90%E9%97%AE/ title=提问>提问</a>
<a class="ui label" href=/tags/%E6%95%99%E7%A8%8B/ title=教程>教程</a>
<a class="ui label" href=/tags/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/ title=数据分析>数据分析</a>
<a class="ui label" href=/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/ title=数据库>数据库</a>
<a class="ui label" href=/tags/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/ title=最佳实践>最佳实践</a>
<a class="ui label" href=/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/ title=“机器学习”>“机器学习”</a>
<a class="ui label" href=/tags/%E6%AD%BB%E6%9C%BA/ title=死机>死机</a>
<a class="ui label" href=/tags/%E6%B3%9B%E5%9E%8B/ title=泛型>泛型</a>
<a class="ui label" href=/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/ title=“深度学习”>“深度学习”</a>
<a class="ui label" href=/tags/%E6%B8%B8%E8%AE%B0/ title=游记>游记</a>
<a class="ui label" href=/tags/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/ title=科学上网>科学上网</a>
<a class="ui label" href=/tags/%E7%AE%97%E5%AD%90/ title=算子>算子</a>
<a class="ui label" href=/tags/%E7%BC%96%E8%AF%91%E5%99%A8%E4%BC%98%E5%8C%96/ title=编译器优化>编译器优化</a>
<a class="ui label" href=/tags/%E7%BF%BB%E8%AF%91/ title=翻译>翻译</a>
<a class="ui label" href=/tags/%E8%87%AA%E8%A1%8C%E8%BD%A6/ title=自行车>自行车</a>
<a class="ui label" href=/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/ title=读书笔记>读书笔记</a></article></div></header><div class="ui relaxed grid dream-grid dream-back"><div class="sixteen wide mobile eight wide tablet four wide computer column dream-column"><article class="ui segment markdown-body"><div class="ui medium header">关于</div><p>要么忙着生活，要么赶着去死!</p></article></div><div class="sixteen wide mobile eight wide tablet four wide computer column dream-column"><article class="ui segment"><div class="ui medium header">社交链接</div><nav class="ui secondary menu dream-menu dream-socials"><div class=item><a href=/index.xml><i class="large rss square icon" title=RSS></i></a></div><div class=item><a href=mailto:lixianwa@gmail.com><i class="large mail icon" title=Email></i></a></div></nav></article></div><div class="sixteen wide mobile eight wide tablet four wide computer column dream-column"><article class="ui segment"><a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/><img alt=知识共享许可协议 style=border-width:0 src=https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png></a><br>本作品采用<a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。</article></div></div></div></section></div></div><script>window.defaultDark=null,window.backgroundDark="black",window.backgroundImageDark=null,window.darkNav=null,window.hasTwitterEmbed=null,window.hasTwitterEmbed&&(window.twttr=function(c,d,e){var b,f=c.getElementsByTagName(d)[0],a=window.twttr||{};return c.getElementById(e)?a:(b=c.createElement(d),b.id=e,b.src='https://platform.twitter.com/widgets.js',f.parentNode.insertBefore(b,f),a._e=[],a.ready=function(b){a._e.push(b)},a)}(document,'script','twitter-wjs'))</script><script src=/js/jquery.min.js></script><script src=/js/semantic.min.js></script><script src=/js/jquery.overlayScrollbars.min.js></script><script src=/js/header.js></script><script src=/js/main.js></script><script src=/js/theme.js></script><script src=/js/html2canvas.min.js></script><script src=/js/post.js></script><script src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/highlight.min.js></script><script src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/languages/ocaml.min.js></script><script>hljs.initHighlightingOnLoad(),setHighlightTheme();function setHighlightTheme(){var a=localStore.getItem('hugo-theme-dream-is-dark'),b,c,d;a=a?a:window.defaultDark?'y':a,b="gruvbox-light",c="gruvbox-dark",d=a==='y'?c:b,$('link[data-highlight]').attr('href','https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/styles/'+d+'.min.css'),$('pre').css('background',a==='y'?'#333':'')}</script><div class="ui inverted segment" id=dream-search><div class="ui search"><div class="ui transparent input"><input class=prompt type=text placeholder=搜索></div><div class=results></div></div></div><script>$(document).ready(function(){$.getJSON('https://lixianwa.github.io//index.json',function(a){$('.ui.search').search({source:a,searchFields:['title'],showNoResults:!0})})})</script><script src=/js/search.js></script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','172168556','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>