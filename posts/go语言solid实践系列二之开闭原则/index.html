<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>Go语言SOLID实践系列二之开闭原则 | Lionel's Blog</title><link href=/favicon.ico rel="shortcut icon" type=image/x-icon><meta name=author content="归零"><meta name=description content="引用wikipedia上对开闭原则的解释：
 在面向对象编程领域中，开闭原则 (The Open/Closed Principle, OCP) 规定“软件中的对象（类，模块，函数等等）应该对于扩展是开放的，但是对于修改是封闭的”，这意味着一个实体是允许在不改变它的源代码的前提下变更它的行为。该特性在产品化的环境中是特别有价值的，在这种环境中，改变源代码需要代码审查，单元测试以及诸如此类的用以确保产品使用品质的过程。遵循这种原则的代码在扩展时并不发生改变，因此无需上述的过程。
 在本文中，我们将通过实践的方式深入探索这一原则。
"><meta name=generator content="Hugo 0.81.0"><link rel=canonical href=https://lixianwa.github.io/posts/go%E8%AF%AD%E8%A8%80solid%E5%AE%9E%E8%B7%B5%E7%B3%BB%E5%88%97%E4%BA%8C%E4%B9%8B%E5%BC%80%E9%97%AD%E5%8E%9F%E5%88%99/><meta property="og:title" content="Go语言SOLID实践系列二之开闭原则"><meta property="og:description" content="引用wikipedia上对开闭原则的解释：

在面向对象编程领域中，开闭原则 (The Open/Closed Principle, OCP) 规定“软件中的对象（类，模块，函数等等）应该对于扩展是开放的，但是对于修改是封闭的”，这意味着一个实体是允许在不改变它的源代码的前提下变更它的行为。该特性在产品化的环境中是特别有价值的，在这种环境中，改变源代码需要代码审查，单元测试以及诸如此类的用以确保产品使用品质的过程。遵循这种原则的代码在扩展时并不发生改变，因此无需上述的过程。

在本文中，我们将通过实践的方式深入探索这一原则。"><meta property="og:type" content="article"><meta property="og:url" content="https://lixianwa.github.io/posts/go%E8%AF%AD%E8%A8%80solid%E5%AE%9E%E8%B7%B5%E7%B3%BB%E5%88%97%E4%BA%8C%E4%B9%8B%E5%BC%80%E9%97%AD%E5%8E%9F%E5%88%99/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-25T13:43:37+08:00"><meta property="article:modified_time" content="2021-12-25T13:43:37+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Go语言SOLID实践系列二之开闭原则"><meta name=twitter:description content="引用wikipedia上对开闭原则的解释：

在面向对象编程领域中，开闭原则 (The Open/Closed Principle, OCP) 规定“软件中的对象（类，模块，函数等等）应该对于扩展是开放的，但是对于修改是封闭的”，这意味着一个实体是允许在不改变它的源代码的前提下变更它的行为。该特性在产品化的环境中是特别有价值的，在这种环境中，改变源代码需要代码审查，单元测试以及诸如此类的用以确保产品使用品质的过程。遵循这种原则的代码在扩展时并不发生改变，因此无需上述的过程。

在本文中，我们将通过实践的方式深入探索这一原则。"><link rel=stylesheet href=/css/semantic.min.css><link rel=stylesheet href=/css/icomoon.css><link rel=stylesheet href=/css/OverlayScrollbars.min.css><link rel=stylesheet href=/css/github-markdown.css><link rel=stylesheet href=/css/site.css><style>a:not(.ui.button):hover{text-decoration:underline}a:not(.ui.button){color:#2e8b57!important}.inverted a:not(.ui.button),.inverted a:not(.ui.button):hover{color:#8fbc8f!important}body.default{background-color:#f7f7f7;background-image:url(/me/background.jpeg)}body.dark{background-color:#000}</style><link rel=stylesheet data-highlight href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/styles/gruvbox-light.min.css><link rel=stylesheet href=/css/custom.css></head><body class=default><nav class="ui secondary menu dream-menu"><div class=item><i class="large link bullseye icon dream-flip-toggle" title=翻转！></i></div><div class=item><i class="large link home icon" title=首页 onclick="window.location.href='https://lixianwa.github.io/'"></i></div><div class=item><i class="large link icon theme-switch" onclick=themeSwitch()></i></div><div class=item><i class="large link search icon" onclick=toggleSearch()></i></div></nav><div class=flip-container><div class=flipper><section class=front><div class=dream-max-width><div class="ui relaxed grid dream-grid dream-grid-single"><aside class="sixteen wide mobile sixteen wide tablet four wide computer column dream-single-aside"><div class="ui segment toc"><nav id=TableOfContents><ul><li><a href=#当我们不遵守开闭原则时>当我们不遵守开闭原则时</a></li><li><a href=#如何遵守开闭原则>如何遵守开闭原则</a></li><li><a href=#一些更多的例子>一些更多的例子</a></li><li><a href=#总结>总结</a></li></ul></nav></div><div class="ui segment actions"><button class="ui circular icon button save-as-image" title=保存为图片 onclick=savePostAsImg()>
<i class="save icon"></i></button>
<a href="https://twitter.com/intent/tweet?text=Go%e8%af%ad%e8%a8%80SOLID%e5%ae%9e%e8%b7%b5%e7%b3%bb%e5%88%97%e4%ba%8c%e4%b9%8b%e5%bc%80%e9%97%ad%e5%8e%9f%e5%88%99&url=https%3a%2f%2flixianwa.github.io%2fposts%2fgo%25E8%25AF%25AD%25E8%25A8%2580solid%25E5%25AE%259E%25E8%25B7%25B5%25E7%25B3%25BB%25E5%2588%2597%25E4%25BA%258C%25E4%25B9%258B%25E5%25BC%2580%25E9%2597%25AD%25E5%258E%259F%25E5%2588%2599%2f" class="ui circular twitter icon button"><i class="twitter icon"></i></a><a href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2flixianwa.github.io%2fposts%2fgo%25E8%25AF%25AD%25E8%25A8%2580solid%25E5%25AE%259E%25E8%25B7%25B5%25E7%25B3%25BB%25E5%2588%2597%25E4%25BA%258C%25E4%25B9%258B%25E5%25BC%2580%25E9%2597%25AD%25E5%258E%259F%25E5%2588%2599%2f" class="ui circular facebook icon button"><i class="facebook icon"></i></a></div></aside><div class="sixteen wide mobile sixteen wide tablet twelve wide computer column markdown-body dream-single" id=dream-save-post-as-img><section class="ui attached segment"><header><h1 class="ui large header">Go语言SOLID实践系列二之开闭原则<div class="sub header">@
归零
|
星期六，十二月 25 日，2021 年
| 3 分钟阅读
| 更新于
星期六，十二月 25 日，2021 年</div></h1></header><article class=main><p>引用wikipedia上对<code>开闭原则</code>的解释：</p><blockquote><p>在面向对象编程领域中，开闭原则 (The Open/Closed Principle, OCP) 规定“软件中的对象（类，模块，函数等等）应该对于扩展是开放的，但是对于修改是封闭的”，这意味着一个实体是允许在不改变它的源代码的前提下变更它的行为。该特性在产品化的环境中是特别有价值的，在这种环境中，改变源代码需要代码审查，单元测试以及诸如此类的用以确保产品使用品质的过程。遵循这种原则的代码在扩展时并不发生改变，因此无需上述的过程。</p></blockquote><p>在本文中，我们将通过实践的方式深入探索这一原则。</p><h2 id=当我们不遵守开闭原则时>当我们不遵守开闭原则时</h2><p>OCP的要求，我们可以在上面看到，Bob大叔在他的<a href=http://blog.cleancoder.com/uncle-bob/2014/05/12/TheOpenClosedPrinciple.html>博客</a>中提供了。我更喜欢这种定义开闭原则的方式，因为这样展示出它全部的亮点。
乍一看，我们可能会认为这是一个荒谬的要求。是的，说真的，我们应该如何在不修改的情况下扩展某些东西？意思是，有没有可能在不改变它的情况下改变一些事情？
通过检查下面的代码示例，我们可以看到某些结构不遵守此原则和可能带来的后果å。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;net/http&#34;</span>

	<span style=color:#e6db74>&#34;github.com/ahmetb/go-linq&#34;</span>
	<span style=color:#e6db74>&#34;github.com/gin-gonic/gin&#34;</span>
)

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>PermissionChecker</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#75715e>//
</span><span style=color:#75715e></span>	<span style=color:#75715e>// some fields
</span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span><span style=color:#75715e></span>}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PermissionChecker</span>) <span style=color:#a6e22e>HasPermission</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>bool</span> {
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>permissions</span> []<span style=color:#66d9ef>string</span>
	<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>GetString</span>(<span style=color:#e6db74>&#34;authType&#34;</span>) {
	<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;jwt&#34;</span>:
		<span style=color:#a6e22e>permissions</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>extractPermissionsFromJwt</span>(<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Header</span>)
	<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;basic&#34;</span>:
		<span style=color:#a6e22e>permissions</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>getPermissionsForBasicAuth</span>(<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Header</span>)
	<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;applicationKey&#34;</span>:
		<span style=color:#a6e22e>permissions</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>getPermissionsForApplicationKey</span>(<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Query</span>(<span style=color:#e6db74>&#34;applicationKey&#34;</span>))
	}
	
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>result</span> []<span style=color:#66d9ef>string</span>
	<span style=color:#a6e22e>linq</span>.<span style=color:#a6e22e>From</span>(<span style=color:#a6e22e>permissions</span>).
		<span style=color:#a6e22e>Where</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>permission</span> <span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>bool</span> {
			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>permission</span>.(<span style=color:#66d9ef>string</span>) <span style=color:#f92672>==</span> <span style=color:#a6e22e>name</span>
		}).<span style=color:#a6e22e>ToSlice</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>result</span>)

	<span style=color:#66d9ef>return</span> len(<span style=color:#a6e22e>result</span>) &gt; <span style=color:#ae81ff>0</span>
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PermissionChecker</span>) <span style=color:#a6e22e>getPermissionsForApplicationKey</span>(<span style=color:#a6e22e>key</span> <span style=color:#66d9ef>string</span>) []<span style=color:#66d9ef>string</span> {
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>result</span> []<span style=color:#66d9ef>string</span>
	<span style=color:#75715e>//
</span><span style=color:#75715e></span>	<span style=color:#75715e>// extract JWT from the request header
</span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>result</span>
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PermissionChecker</span>) <span style=color:#a6e22e>getPermissionsForBasicAuth</span>(<span style=color:#a6e22e>h</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Header</span>) []<span style=color:#66d9ef>string</span> {
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>result</span> []<span style=color:#66d9ef>string</span>
	<span style=color:#75715e>//
</span><span style=color:#75715e></span>	<span style=color:#75715e>// extract JWT from the request header
</span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>result</span>
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PermissionChecker</span>) <span style=color:#a6e22e>extractPermissionsFromJwt</span>(<span style=color:#a6e22e>h</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Header</span>) []<span style=color:#66d9ef>string</span> {
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>result</span> []<span style=color:#66d9ef>string</span>
	<span style=color:#75715e>//
</span><span style=color:#75715e></span>	<span style=color:#75715e>// extract JWT from the request header
</span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>result</span>
}
</code></pre></div><p>这个例子展示了一个结构体，即PermissionChecker。它应该检查是否有访问某些资源所需的权限，这取决于Gin包支持的网络应用程序的Context。</p><p>这里我们有一个主要的方法HasPermission，它检查特定名称的权限是否与Context中的数据相关。</p><p>从Context中检索权限可能会有所不同，这取决于用户是用JWT令牌、基本授权还是应用密钥进行授权。在这个结构中，我们提供了所有不同的权限片的提取。</p><p>如果我们遵守单一责任原则，PermissionChecker负责决定权限是否在Context内，它与授权过程没有任何关系。</p><p>一定是授权过程被定义在其他地方，在其他的结构中，甚至是不同的模块中。所以，如果我们想在其他地方扩展授权流程，我们也需要在这里调整逻辑。
假设我们想扩展授权逻辑并添加一些新的流程，比如将用户数据保留在会话中或使用摘要授权。在这种情况下，我们也需要对PermissionChecker进行调整。</p><p>这样的实现带来了问题爆发：</p><ul><li>PermissionChecker保持最初在其他地方处理的逻辑。</li><li>任何对授权逻辑的调整，可能是不同的模块，都需要在PermissionChecker中进行调整。</li><li>要增加一种提取权限的新方法，我们总是需要修改PermissionChecker。</li><li>PermissionChecker内部的逻辑不可避免地随着每一个新的授权流程而增长。</li><li>PermissionChecker的单元测试包含了太多关于不同权限提取的技术细节。</li><li>…</li></ul><p>所以，现在再次，我们有一些代码要重构。</p><h2 id=如何遵守开闭原则>如何遵守开闭原则</h2><blockquote><p>开放/封闭原则说软件结构应该对扩展开放，对修改封闭。</p></blockquote><p>上面的声明为我们的新代码提供了一些可能的方向，它应该遵守OCP。这段代码应该提供一些允许从外部推送的扩展。</p><p>在面向对象编程中，我们通过对同一接口使用不同的实现来支持这种扩展。换句话说，我们使用多态性。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>PermissionProvider</span> <span style=color:#66d9ef>interface</span> {
	<span style=color:#a6e22e>Type</span>() <span style=color:#66d9ef>string</span>
	<span style=color:#a6e22e>GetPermissions</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) []<span style=color:#66d9ef>string</span>
}

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>PermissionChecker</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>providers</span> []<span style=color:#a6e22e>PermissionProvider</span>
	<span style=color:#75715e>//
</span><span style=color:#75715e></span>	<span style=color:#75715e>// some fields
</span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span><span style=color:#75715e></span>}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PermissionChecker</span>) <span style=color:#a6e22e>HasPermission</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>bool</span> {
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>permissions</span> []<span style=color:#66d9ef>string</span>
	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>provider</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>providers</span> {
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>GetString</span>(<span style=color:#e6db74>&#34;authType&#34;</span>) <span style=color:#f92672>!=</span> <span style=color:#a6e22e>provider</span>.<span style=color:#a6e22e>Type</span>() {
			<span style=color:#66d9ef>continue</span>
		}
		
		<span style=color:#a6e22e>permissions</span> = <span style=color:#a6e22e>provider</span>.<span style=color:#a6e22e>GetPermissions</span>(<span style=color:#a6e22e>ctx</span>)
		<span style=color:#66d9ef>break</span>
	}

	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>result</span> []<span style=color:#66d9ef>string</span>
	<span style=color:#a6e22e>linq</span>.<span style=color:#a6e22e>From</span>(<span style=color:#a6e22e>permissions</span>).
		<span style=color:#a6e22e>Where</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>permission</span> <span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>bool</span> {
			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>permission</span>.(<span style=color:#66d9ef>string</span>) <span style=color:#f92672>==</span> <span style=color:#a6e22e>name</span>
		}).<span style=color:#a6e22e>ToSlice</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>result</span>)

	<span style=color:#66d9ef>return</span> len(<span style=color:#a6e22e>result</span>) &gt; <span style=color:#ae81ff>0</span>
}
</code></pre></div><p>在上面的例子中，我们可以看到一个尊重OCP的候选者。适配器PermissionChecker并没有隐藏从Context中提取权限的技术细节。</p><p>相反，我们引入了一个新的接口，PermissionProvider。这个新结构代表了放置不同权限提取逻辑的地方。</p><p>例如，它可以是JwtPermissionProvider，或ApiKeyPermissionProvider，或AuthBasicPermissionProvider。现在，负责授权的模块也可以包含权限的提取器。</p><p>这意味着我们可以把关于授权用户的逻辑放在一个地方，而不是把它散布在代码中。</p><p>另一方面，我们的主要目标是扩展PermissionChecker，而不需要修改它，现在可以实现了。我们可以用我们想要的不同的PermissionProviders来初始化PermissionChecker。</p><p>假设我们需要添加一种从session密钥获取权限的可能性。在这种情况下，我们需要实现一个新的SessionPermissionProvider，它将从Context中提取cookie并使用它从SessionStore中获取权限。</p><p>使之有可能在我们需要的时候扩展PermissionChecker，而不再修改其内部逻辑。现在我们看到了什么是对扩展的开放和对修改的封闭。</p><h2 id=一些更多的例子>一些更多的例子</h2><p>前面的问题我们可以用一个稍微不同的方法来解决。让我们看下面的代码片段。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>PermissionProvider</span> <span style=color:#66d9ef>interface</span> {
	<span style=color:#a6e22e>Type</span>() <span style=color:#66d9ef>string</span>
	<span style=color:#a6e22e>GetPermissions</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) []<span style=color:#66d9ef>string</span>
}

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>PermissionChecker</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#75715e>//
</span><span style=color:#75715e></span>	<span style=color:#75715e>// some fields
</span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span><span style=color:#75715e></span>}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PermissionChecker</span>) <span style=color:#a6e22e>HasPermission</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>provider</span> <span style=color:#a6e22e>PermissionProvider</span>, <span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>bool</span> {
	<span style=color:#a6e22e>permissions</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>provider</span>.<span style=color:#a6e22e>GetPermissions</span>(<span style=color:#a6e22e>ctx</span>)

	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>result</span> []<span style=color:#66d9ef>string</span>
	<span style=color:#a6e22e>linq</span>.<span style=color:#a6e22e>From</span>(<span style=color:#a6e22e>permissions</span>).
		<span style=color:#a6e22e>Where</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>permission</span> <span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>bool</span> {
			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>permission</span>.(<span style=color:#66d9ef>string</span>) <span style=color:#f92672>==</span> <span style=color:#a6e22e>name</span>
		}).<span style=color:#a6e22e>ToSlice</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>result</span>)

	<span style=color:#66d9ef>return</span> len(<span style=color:#a6e22e>result</span>) &gt; <span style=color:#ae81ff>0</span>
}
</code></pre></div><p>通过新的实现，我们从PermissionChecker中删除了PermissionProviders。相反，我们将正确的provider定义为HasPermission方法的一个参数。</p><p>我更喜欢第一种方法，但这个方法也可能是一个解决方案，这取决于我们应用程序中的使用情况。</p><p>我们可以将 &ldquo;开/闭原则 &ldquo;应用于方法，而不仅仅是结构。如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>GetCities</span>(<span style=color:#a6e22e>sourceType</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>source</span> <span style=color:#66d9ef>string</span>) ([]<span style=color:#a6e22e>City</span>, <span style=color:#66d9ef>error</span>) {
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>data</span> []<span style=color:#66d9ef>byte</span>
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>

	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sourceType</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;file&#34;</span> {
		<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadFile</span>(<span style=color:#a6e22e>source</span>)
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
		}
	} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sourceType</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;link&#34;</span> {
		<span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>source</span>)
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
		}

		<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadAll</span>(<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>)
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
		}
		<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>.<span style=color:#a6e22e>Close</span>()
	}

	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>cities</span> []<span style=color:#a6e22e>City</span>
	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>yaml</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>data</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cities</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
	}

	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cities</span>, <span style=color:#66d9ef>nil</span>
}
</code></pre></div><p>函数GetCities从某个来源读取城市列表。这个来源可能是一个文件或互联网上的一些资源。不过，我们将来可能想从内存、Redis或其他任何来源读取数据。</p><p>所以在某种程度上，让读取原始数据的过程更抽象一些会更好。既然如此，我们可以从外部提供一个读取策略作为方法参数。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>DataReader</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>source</span> <span style=color:#66d9ef>string</span>) ([]<span style=color:#66d9ef>byte</span>, <span style=color:#66d9ef>error</span>)

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ReadFromFile</span>(<span style=color:#a6e22e>fileName</span> <span style=color:#66d9ef>string</span>) ([]<span style=color:#66d9ef>byte</span>, <span style=color:#66d9ef>error</span>) {
	<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadFile</span>(<span style=color:#a6e22e>fileName</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
	}

	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>data</span>, <span style=color:#66d9ef>nil</span>
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ReadFromLink</span>(<span style=color:#a6e22e>link</span> <span style=color:#66d9ef>string</span>) ([]<span style=color:#66d9ef>byte</span>, <span style=color:#66d9ef>error</span>) {
	<span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>link</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
	}

	<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadAll</span>(<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
	}
	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>.<span style=color:#a6e22e>Close</span>()

	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>data</span>, <span style=color:#66d9ef>nil</span>
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>GetCities</span>(<span style=color:#a6e22e>reader</span> <span style=color:#a6e22e>DataReader</span>, <span style=color:#a6e22e>source</span> <span style=color:#66d9ef>string</span>) ([]<span style=color:#a6e22e>City</span>, <span style=color:#66d9ef>error</span>) {
	<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>reader</span>(<span style=color:#a6e22e>source</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
	}

	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>cities</span> []<span style=color:#a6e22e>City</span>
	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>yaml</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>data</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cities</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
	}

	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cities</span>, <span style=color:#66d9ef>nil</span>
}
</code></pre></div><p>如上代码所示，在Go中，我们可以定义一个新的类型来嵌入函数。这里我们描述了一个新的类型，DataReader，代表了一个从某个源头读取原始数据的函数类型。</p><p>新方法ReadFromFile和ReadFromLink是DataReader类型的具体实现。GetCities方法期望DataReader的具体实现作为一个参数，然后在函数体内部执行并获取原始数据。</p><p>正如你所看到的，OCP的主要目的是给我们的代码和我们代码的用户提供更多的灵活性。只要有人能够扩展我们的库，而不fork它们，为它们提供pull requests，或以任何方式修改它们，我们的库就具有真正的价值。</p><h2 id=总结>总结</h2><p>开闭原则是第二个SOLID原则，它代表字母O。它指导我们应该总是在不修改代码结构的情况下扩展它们。</p><p>在其源头，我们应该使用多态性来满足这一要求。我们的代码应该提供一个简单的接口来增加这种可扩展性。</p><p>参考：
1、https://levelup.gitconnected.com/practical-solid-in-golang-open-closed-principle-1dd361565452
2、https://zh.wikipedia.org/wiki/%E5%BC%80%E9%97%AD%E5%8E%9F%E5%88%99</p></article></section><article class="ui segment utterances-comments" data-html2canvas-ignore><script src=https://utteranc.es/client.js repo=lixianwa/comments-for-myblog issue-term=og:title theme=github-light crossorigin=anonymous async></script></article></div></div><footer class="ui basic center aligned segment" style=background-color:initial><p>© 2014 - 2022 Lionel's Blog</p><p>Powered by <a href=https://gohugo.io/ target=_blank>Hugo</a> with theme <a href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</p></footer></div></section><section class=back><div class=dream-max-width><header class="ui basic very padded segment dream-header"><div class="ui small circular image"><img src=/me/avatar.jpeg alt=avatar></div><div class=content><h1 class="ui medium header">归零的小窝<div class="sub header">收集、总结、分享</div></h1><article class="ui horizontal list"><a class=item href=/posts><i class="archive icon" title=归档></i></a><a class=item href=/categories><i class="th list icon" title=所有分类></i></a><a class=item href=/tags><i class="tags icon" title=所有标签></i></a></article><article class=dream-tags><a class="ui label" href=/tags/archlinux/ title=archlinux>archlinux</a>
<a class="ui label" href=/tags/arthas/ title=arthas>arthas</a>
<a class="ui label" href=/tags/bug/ title=bug>bug</a>
<a class="ui label" href=/tags/c%E8%AF%AD%E8%A8%80/ title=c语言>c语言</a>
<a class="ui label" href=/tags/dapr/ title=Dapr>Dapr</a>
<a class="ui label" href=/tags/debug/ title=debug>debug</a>
<a class="ui label" href=/tags/dlv/ title=dlv>dlv</a>
<a class="ui label" href=/tags/go/ title=Go>Go</a>
<a class="ui label" href=/tags/grpc/ title=gRPC>gRPC</a>
<a class="ui label" href=/tags/headless-service/ title="Headless service">Headless service</a>
<a class="ui label" href=/tags/hexo/ title=Hexo>Hexo</a>
<a class="ui label" href=/tags/ios/ title=iOS>iOS</a>
<a class="ui label" href=/tags/java/ title=java>java</a>
<a class="ui label" href=/tags/jekyll/ title=jekyll>jekyll</a>
<a class="ui label" href=/tags/jupyter-notebook/ title="Jupyter notebook">Jupyter notebook</a>
<a class="ui label" href=/tags/kubernetes/ title=Kubernetes>Kubernetes</a>
<a class="ui label" href=/tags/markdown/ title=markdown>markdown</a>
<a class="ui label" href=/tags/mongodb/ title=mongodb>mongodb</a>
<a class="ui label" href=/tags/nginx/ title=nginx>nginx</a>
<a class="ui label" href=/tags/pandas/ title=Pandas>Pandas</a>
<a class="ui label" href=/tags/reactivecocoa/ title=ReactiveCocoa>ReactiveCocoa</a>
<a class="ui label" href=/tags/redis/ title=redis>redis</a>
<a class="ui label" href=/tags/restful-api/ title="RESTFul API">RESTFul API</a>
<a class="ui label" href=/tags/solid/ title=SOLID>SOLID</a>
<a class="ui label" href=/tags/swift/ title=Swift>Swift</a>
<a class="ui label" href=/tags/v2ray/ title=v2ray>v2ray</a>
<a class="ui label" href=/tags/xcode/ title=Xcode>Xcode</a>
<a class="ui label" href=/tags/%E5%86%85%E5%AD%98/ title=内存>内存</a>
<a class="ui label" href=/tags/%E5%8D%9A%E5%AE%A2/ title=博客>博客</a>
<a class="ui label" href=/tags/%E5%B7%A5%E5%85%B7/ title=工具>工具</a>
<a class="ui label" href=/tags/%E5%BC%80%E6%BA%90/ title=开源>开源</a>
<a class="ui label" href=/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/ title=微服务>微服务</a>
<a class="ui label" href=/tags/%E6%8F%90%E9%97%AE/ title=提问>提问</a>
<a class="ui label" href=/tags/%E6%95%99%E7%A8%8B/ title=教程>教程</a>
<a class="ui label" href=/tags/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/ title=数据分析>数据分析</a>
<a class="ui label" href=/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/ title=数据库>数据库</a>
<a class="ui label" href=/tags/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/ title=最佳实践>最佳实践</a>
<a class="ui label" href=/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/ title=“机器学习”>“机器学习”</a>
<a class="ui label" href=/tags/%E6%AD%BB%E6%9C%BA/ title=死机>死机</a>
<a class="ui label" href=/tags/%E6%B3%9B%E5%9E%8B/ title=泛型>泛型</a>
<a class="ui label" href=/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/ title=“深度学习”>“深度学习”</a>
<a class="ui label" href=/tags/%E6%B8%B8%E8%AE%B0/ title=游记>游记</a>
<a class="ui label" href=/tags/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/ title=科学上网>科学上网</a>
<a class="ui label" href=/tags/%E7%AE%97%E5%AD%90/ title=算子>算子</a>
<a class="ui label" href=/tags/%E7%BF%BB%E8%AF%91/ title=翻译>翻译</a>
<a class="ui label" href=/tags/%E8%87%AA%E8%A1%8C%E8%BD%A6/ title=自行车>自行车</a>
<a class="ui label" href=/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/ title=读书笔记>读书笔记</a></article></div></header><div class="ui relaxed grid dream-grid dream-back"><div class="sixteen wide mobile eight wide tablet four wide computer column dream-column"><article class="ui segment markdown-body"><div class="ui medium header">关于</div><p>要么忙着生活，要么赶着去死!</p></article></div><div class="sixteen wide mobile eight wide tablet four wide computer column dream-column"><article class="ui segment"><div class="ui medium header">社交链接</div><nav class="ui secondary menu dream-menu dream-socials"><div class=item><a href=/index.xml><i class="large rss square icon" title=RSS></i></a></div><div class=item><a href=mailto:lixianwa@gmail.com><i class="large mail icon" title=Email></i></a></div></nav></article></div><div class="sixteen wide mobile eight wide tablet four wide computer column dream-column"><article class="ui segment"><a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/><img alt=知识共享许可协议 style=border-width:0 src=https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png></a><br>本作品采用<a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。</article></div></div></div></section></div></div><script>window.defaultDark=null,window.backgroundDark="black",window.backgroundImageDark=null,window.darkNav=null,window.hasTwitterEmbed=null,window.hasTwitterEmbed&&(window.twttr=function(c,d,e){var b,f=c.getElementsByTagName(d)[0],a=window.twttr||{};return c.getElementById(e)?a:(b=c.createElement(d),b.id=e,b.src='https://platform.twitter.com/widgets.js',f.parentNode.insertBefore(b,f),a._e=[],a.ready=function(b){a._e.push(b)},a)}(document,'script','twitter-wjs'))</script><script src=/js/jquery.min.js></script><script src=/js/semantic.min.js></script><script src=/js/jquery.overlayScrollbars.min.js></script><script src=/js/header.js></script><script src=/js/main.js></script><script src=/js/theme.js></script><script src=/js/html2canvas.min.js></script><script src=/js/post.js></script><script src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/highlight.min.js></script><script src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/languages/ocaml.min.js></script><script>hljs.initHighlightingOnLoad(),setHighlightTheme();function setHighlightTheme(){var a=localStore.getItem('hugo-theme-dream-is-dark'),b,c,d;a=a?a:window.defaultDark?'y':a,b="gruvbox-light",c="gruvbox-dark",d=a==='y'?c:b,$('link[data-highlight]').attr('href','https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/styles/'+d+'.min.css'),$('pre').css('background',a==='y'?'#333':'')}</script><div class="ui inverted segment" id=dream-search><div class="ui search"><div class="ui transparent input"><input class=prompt type=text placeholder=搜索></div><div class=results></div></div></div><script>$(document).ready(function(){$.getJSON('https://lixianwa.github.io//index.json',function(a){$('.ui.search').search({source:a,searchFields:['title'],showNoResults:!0})})})</script><script src=/js/search.js></script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','172168556','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>